#!/bin/bash
# sync-incremental.sh — Тихий инкрементный push для cron
# Не выводит ничего кроме ошибок. Логи в ~/.antigravity-sync.log

set -euo pipefail

LOG="$HOME/.antigravity-sync.log"
SERVER_IP="195.133.15.207"
SERVER="root@$SERVER_IP"
REMOTE_BASE="/opt/antigravity"

log() { echo "[$(date '+%H:%M:%S')] $1" >> "$LOG"; }

# Ротация лога (макс 1000 строк)
[ -f "$LOG" ] && tail -500 "$LOG" > "$LOG.tmp" && mv "$LOG.tmp" "$LOG" 2>/dev/null

# Проверка SSH (тихо, быстро)
if ! SSH_AUTH_SOCK="" ssh -o ConnectTimeout=3 -o BatchMode=yes "$SERVER" "true" 2>/dev/null; then
    log "SKIP: SSH unavailable"
    exit 0
fi

sync_scp() {
    local src="$1" dst="$2"
    if [ -e "$src" ]; then
        SSH_AUTH_SOCK="" scp -q -r -o StrictHostKeyChecking=no "$src" "$SERVER:$dst" 2>/dev/null
    fi
}

# Создать директории (один раз)
SSH_AUTH_SOCK="" ssh "$SERVER" "mkdir -p $REMOTE_BASE/{skills,workflows,brain,conversations,knowledge,hub-skills,project,ssh,meta}" 2>/dev/null

CHANGED=0

# Skills + workflows + rules
sync_scp "$HOME/.agent/skills/" "$REMOTE_BASE/" && CHANGED=$((CHANGED+1))
sync_scp "$HOME/.agent/workflows/" "$REMOTE_BASE/" && CHANGED=$((CHANGED+1))
[ -f "$HOME/.agent/rules.md" ] && sync_scp "$HOME/.agent/rules.md" "$REMOTE_BASE/"

# Brain + conversations + knowledge  
sync_scp "$HOME/.gemini/antigravity/brain/" "$REMOTE_BASE/" && CHANGED=$((CHANGED+1))
sync_scp "$HOME/.gemini/antigravity/conversations/" "$REMOTE_BASE/" && CHANGED=$((CHANGED+1))
sync_scp "$HOME/.gemini/antigravity/knowledge/" "$REMOTE_BASE/" && CHANGED=$((CHANGED+1))

# Hub skills + project
sync_scp "$HOME/.gemini/antigravity/skills/" "$REMOTE_BASE/hub-skills/" && CHANGED=$((CHANGED+1))
sync_scp "$HOME/dev/antigravity/" "$REMOTE_BASE/project/" && CHANGED=$((CHANGED+1))

# SSH config
[ -f "$HOME/.ssh/config" ] && sync_scp "$HOME/.ssh/config" "$REMOTE_BASE/ssh/"

log "OK: synced ($CHANGED components)"
