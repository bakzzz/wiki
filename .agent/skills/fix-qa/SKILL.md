---
name: fix-qa
description: >
  Исправление QA-проблем, найденных при аудите. Добавление тестов, покрытие edge cases,
  исправление flaky тестов, настройка CI. Тесты не должны ломать существующий код.
  Триггеры: "исправь тесты", "fix qa", "добавь тесты", "увеличь покрытие".
---

# Fix QA

Исправление проблем тестирования, найденных при fullstack-review.

## Методология безопасного исправления

### Принципы

1. **Тесты проверяют поведение, не имплементацию**
2. **Новые тесты не должны трогать production-код** (только test-файлы)
3. **Запускать тесты после каждого добавления** — убедиться что проходят
4. **Не мокать SUT** — только зависимости

## Стратегии исправления

### Покрытие тестами
- Определить непокрытые модули: coverage report → найти <70% файлы
- Приоритет: бизнес-логика > API handlers > utilities > UI компоненты
- Unit-тест на функцию: AAA паттерн (Arrange-Act-Assert)
- Integration-тест на эндпоинт: setup DB → request → assert response → cleanup
- E2E: только для критичных flows (login, checkout, CRUD основных сущностей)

### Качество тестов
- Flaky тесты: изолировать зависимости (mock time, DB cleanup, test containers)
- Хардкод data: заменить на factories/fixtures
- Именование: `should [action] when [condition]` или `[method] → [result] given [state]`
- Cleanup: afterEach/tearDown для DB rollback, temp files, mock reset

### Edge Cases
- Null/undefined/empty: тест на каждый параметр функции
- Граничные значения: 0, -1, MAX, пустая строка, очень длинная строка
- Невалидные данные: wrong type, malformed input, SQL injection payload
- Concurrent access: test double-submit, race condition scenarios

### CI интеграция
- Добавить/настроить GitHub Actions / GitLab CI для тестов
- Конфигурация: lint → unit → integration, параллелизация
- Coverage report: добавить coverage threshold в CI config
- Блокировка merge: тесты обязательны для PR

## Logic Check (IN-FLIGHT)

После **каждого** изменённого файла — ответить на 3 вопроса:

1. **СВЯЗЬ**: Это изменение связано с конкретным требованием из RTM/аудита? Каким?
2. **БЕЗОПАСНОСТЬ**: Это изменение НЕ ЛОМАЕТ существующую функциональность?
3. **ПОЛНОТА**: Нет ли пропущенных требований, зависящих от этого шага?

> Если ответ «Нет» или «Не уверен» — **ОСТАНОВИТЬСЯ** и разобраться перед продолжением.

## Ограничения (НЕ делать)

- ❌ Не менять production-код для "удобства тестирования"
- ❌ Не писать тесты которые тестируют framework (jest/pytest), а не бизнес-код
- ❌ Не мокать всё подряд — интеграционные тесты нужны реальные
- ❌ Не добавлять зависимости в production (только в devDependencies)
- ❌ Не удалять существующие тесты без обоснования

## TDD методология (из Obra superpowers)

При добавлении новых тестов использовать строгий Red-Green-Refactor цикл:

### Железное правило
```
НЕТ PRODUCTION КОДА БЕЗ ПАДАЮЩЕГО ТЕСТА
```

### Цикл

1. **RED** — написать тест, описывающий ожидаемое поведение
2. **Verify RED** — запустить, убедиться что падает **по правильной причине**
3. **GREEN** — написать **минимальный** код чтобы тест прошёл
4. **Verify GREEN** — запустить, убедиться что ВСЕ тесты зелёные
5. **REFACTOR** — очистить код, тесты остаются зелёными
6. → Повторить

### Антипаттерны (СТОП-сигналы)

| Сигнал | Действие |
|--------|----------|
| Тест проходит сразу | Тест не тестирует ничего — переписать |
| "and" в имени теста | Разбить на 2+ тестов |
| Тест зависит от порядка | Изолировать — каждый тест независим |
| Mock > 3 зависимостей | Код слишком связан — рефакторить SUT |
| Тест проверяет приватный метод | Тестировать публичный интерфейс |
| "Добавлю тесты потом" | СТОП. Сначала тест, потом код |

### Property-Based Testing (из Trail of Bits)

Для критичных функций добавить property-based тесты:
- **Инварианты**: `balance >= 0`, `sorted(sort(arr)) == sort(arr)`
- **Round-trip**: `decode(encode(x)) == x`
- **Идемпотентность**: `f(f(x)) == f(x)`

## Команды верификации

После каждого fix запускать:
```bash
# JavaScript/TypeScript
npm test                        # unit + integration
npm run test:coverage           # coverage report
npx tsc --noEmit                # type-check

# Python
pytest                          # all tests
pytest --cov=src --cov-report=term-missing  # coverage
mypy src/                       # type-check

# Общие
git diff --stat                 # что изменилось
```

